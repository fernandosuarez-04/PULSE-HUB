name: ğŸ§ª Evaluaciones AutomÃ¡ticas (Evals)

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'server/**'
      - 'evals/**'
      - 'package.json'
      - 'tsconfig.json'
  push:
    branches: [ main, develop ]
    paths:
      - 'server/**'
      - 'evals/**'
      - 'package.json'
      - 'tsconfig.json'

jobs:
  evals:
    name: ğŸ§ª Ejecutar Evaluaciones
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependencias
      run: npm ci
      
    - name: ğŸ”§ Compilar TypeScript
      run: npm run build
      
    - name: ğŸ­ Ejecutar evaluaciones de tono
      run: npm run evals:tone

    - name: âš¡ Ejecutar evaluaciones de latencia
      run: npm run evals:latency

    - name: ğŸ§ª Ejecutar evaluaciones de exactitud
      continue-on-error: true
      run: npm run evals:accuracy
      env:
        OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}

    - name: ğŸ“Š Generar reporte completo
      continue-on-error: true
      run: npm run evals:all
      env:
        OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        
    - name: ğŸ“‹ Subir reporte como artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: evals-report
        path: evals/reports/latest-report.json
        
    - name: ğŸ“Š Comentar en PR con resultados
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            const reportPath = path.join('evals', 'reports', 'latest-report.json');
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            
            const { overall, metrics } = report;
            
            let comment = `## ğŸ§ª Resultados de Evaluaciones AutomÃ¡ticas\n\n`;
            comment += `### ğŸ“Š PuntuaciÃ³n General: **${overall.percentage.toFixed(1)}%** (${overall.score}/${overall.maxScore})\n\n`;
            
            comment += `### ğŸ“ˆ MÃ©tricas Detalladas:\n`;
            metrics.forEach(metric => {
              const emoji = metric.percentage >= 90 ? 'ğŸŸ¢' : metric.percentage >= 75 ? 'ğŸŸ¡' : 'ğŸ”´';
              comment += `- ${emoji} **${metric.metric}**: ${metric.percentage.toFixed(1)}%\n`;
            });
            
            comment += `\n### ğŸ“ Resumen:\n${report.summary}\n\n`;
            
            if (overall.percentage < 75) {
              comment += `âš ï¸ **AtenciÃ³n**: La puntuaciÃ³n general es menor al 75%. Se recomienda revisar los resultados antes de hacer merge.\n`;
            } else {
              comment += `âœ… **Excelente**: La puntuaciÃ³n general es satisfactoria. El agente estÃ¡ listo para producciÃ³n.\n`;
            }
            
            comment += `\n---\n*Reporte generado automÃ¡ticamente por el sistema de evaluaciones*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Error generando comentario:', error);
          }
          
    - name: âŒ Fallar si las evaluaciones no pasan
      if: failure()
      run: |
        echo "âŒ Las evaluaciones fallaron. Revisa los logs para mÃ¡s detalles."
        echo "ğŸ’¡ Tip: AsegÃºrate de que la API key de OpenWeather estÃ© configurada correctamente."
        exit 1
