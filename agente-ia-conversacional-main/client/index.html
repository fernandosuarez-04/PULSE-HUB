<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ü§ñ Agente IA - Estrategias de Inteligencia Artificial</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      padding: 30px;
      max-width: 600px;
      width: 100%;
      text-align: center;
    }

    .title {
      color: #333;
      margin-bottom: 10px;
      font-size: 2.5em;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }

    .status-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      border-left: 5px solid #667eea;
    }

    .status-text {
      font-size: 1.2em;
      color: #333;
      margin-bottom: 10px;
    }

    .connection-status {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #28a745;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    .connection-status.disconnected {
      background: #dc3545;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 30px;
    }

    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 50px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .conversation {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      max-height: 300px;
      overflow-y: auto;
      text-align: left;
    }

    .message {
      margin: 10px 0;
      padding: 10px 15px;
      border-radius: 15px;
      max-width: 80%;
    }

    .message.user {
      background: #667eea;
      color: white;
      margin-left: auto;
    }

    .message.agent {
      background: #e9ecef;
      color: #333;
    }

    .listening {
      color: #28a745;
      font-weight: bold;
    }

    .error {
      color: #dc3545;
      background: #f8d7da;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
    }

    .speaking-indicator {
      color: #667eea;
      font-size: 0.9em;
      font-weight: 500;
      margin-top: 8px;
      animation: pulse 1.5s infinite;
    }

    .voice-info {
      font-size: 0.85em;
      color: #6c757d;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">ü§ñ Agente IA - Estrategias</h1>
    <p class="subtitle">Consulta sobre estrategias de adopci√≥n de IA, capacitaci√≥n y automatizaci√≥n</p>

    <div class="status-card">
      <div class="status-text">
        <span id="connection-status" class="connection-status"></span>
        <span id="status">Conectando...</span>
      </div>
      <div id="speaking-indicator" class="speaking-indicator" style="display: none;">
        üó£Ô∏è Agente hablando... (habla para interrumpir)
      </div>
      <div id="voice-info" class="voice-info" style="display: none;">
        üéôÔ∏è Voz: <span id="selected-voice-name">Cargando...</span>
      </div>
    </div>

    <div id="conversation" class="conversation" style="display: none;">
      <!-- Los mensajes aparecer√°n aqu√≠ -->
    </div>

    <div class="controls">
      <button id="start-listening" class="btn btn-primary">
        üé§ Empezar a Escuchar
      </button>
      <button id="stop-listening" class="btn btn-secondary" disabled>
        ‚èπÔ∏è Parar Escucha
      </button>
      <button id="clear-chat" class="btn btn-secondary">
        üóëÔ∏è Limpiar Chat
      </button>
    </div>

    <div id="error" class="error" style="display: none;"></div>
  </div>

  <script>
    // ============================================================================
    // CONFIGURACI√ìN WEBSOCKET
    // ============================================================================
    const socket = new WebSocket("ws://localhost:3000");
    const status = document.getElementById("status");
    const connectionStatus = document.getElementById("connection-status");
    const conversation = document.getElementById("conversation");
    const startBtn = document.getElementById("start-listening");
    const stopBtn = document.getElementById("stop-listening");
    const clearBtn = document.getElementById("clear-chat");
    const errorDiv = document.getElementById("error");
    const speakingIndicator = document.getElementById("speaking-indicator");
    const voiceInfo = document.getElementById("voice-info");
    const selectedVoiceName = document.getElementById("selected-voice-name");

    let recognition = null;
    let isListening = false;
    let isAgentSpeaking = false;
    let selectedVoice = null;
    let audioStream = null; // Stream de audio para filtros

    // ============================================================================
    // GESTI√ìN DE VOZ NATURAL - SELECCI√ìN DE VOZ ESPA√ëOLA DE CALIDAD
    // ============================================================================

    /**
     * Selecciona la mejor voz espa√±ola disponible en el navegador.
     * Prioriza voces de Google y Microsoft en espa√±ol con timbre femenino.
     *
     * Criterios de selecci√≥n:
     * 1. Voces femeninas espa√±olas de alta calidad
     * 2. Voces de Google (prioritarias por naturalidad)
     * 3. Voces de Microsoft (alternativa de calidad)
     * 4. Voces nativas del navegador en espa√±ol
     */
    function selectBestSpanishVoice() {
      const voices = speechSynthesis.getVoices();
      console.log("üé§ Voces disponibles:", voices.map(v => `${v.name} (${v.lang})`));

      // Prioridad 1: Voces Google femeninas en espa√±ol
      const googleVoices = voices.filter(voice =>
        voice.lang.startsWith('es') &&
        voice.name.toLowerCase().includes('google') &&
        (voice.name.toLowerCase().includes('female') ||
         voice.name.toLowerCase().includes('mujer') ||
         !voice.name.toLowerCase().includes('male'))
      );

      // Prioridad 2: Voces Microsoft femeninas en espa√±ol
      const microsoftVoices = voices.filter(voice =>
        voice.lang.startsWith('es') &&
        voice.name.toLowerCase().includes('microsoft') &&
        (voice.name.toLowerCase().includes('female') ||
         voice.name.toLowerCase().includes('helena') ||
         voice.name.toLowerCase().includes('laura'))
      );

      // Prioridad 3: Cualquier voz espa√±ola de calidad
      const qualityVoices = voices.filter(voice =>
        voice.lang.startsWith('es') &&
        !voice.name.toLowerCase().includes('male')
      );

      // Prioridad 4: Cualquier voz en espa√±ol
      const spanishVoices = voices.filter(voice => voice.lang.startsWith('es'));

      // Seleccionar la mejor disponible
      if (googleVoices.length > 0) {
        selectedVoice = googleVoices[0];
        console.log("‚úÖ Voz Google seleccionada:", selectedVoice.name);
      } else if (microsoftVoices.length > 0) {
        selectedVoice = microsoftVoices[0];
        console.log("‚úÖ Voz Microsoft seleccionada:", selectedVoice.name);
      } else if (qualityVoices.length > 0) {
        selectedVoice = qualityVoices[0];
        console.log("‚úÖ Voz de calidad seleccionada:", selectedVoice.name);
      } else if (spanishVoices.length > 0) {
        selectedVoice = spanishVoices[0];
        console.log("‚ö†Ô∏è Voz espa√±ola b√°sica seleccionada:", selectedVoice.name);
      } else {
        selectedVoice = voices[0]; // Fallback a la primera disponible
        console.warn("‚ö†Ô∏è No se encontr√≥ voz espa√±ola, usando voz por defecto");
      }

      // Mostrar informaci√≥n de la voz seleccionada en la UI
      if (selectedVoice) {
        selectedVoiceName.textContent = selectedVoice.name;
        voiceInfo.style.display = "block";
      }
    }

    // Inicializar voces cuando est√©n disponibles
    // Nota: Las voces pueden cargar de forma as√≠ncrona en Chrome
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = selectBestSpanishVoice;
    }
    // Intentar cargar inmediatamente (funciona en Firefox)
    selectBestSpanishVoice();

    // ============================================================================
    // WEBSOCKET - COMUNICACI√ìN CON EL SERVIDOR
    // ============================================================================

    socket.onopen = () => {
      status.textContent = "Conectado";
      connectionStatus.classList.remove("disconnected");
      showError("", false);
    };

    socket.onclose = () => {
      status.textContent = "Desconectado";
      connectionStatus.classList.add("disconnected");
      showError("Conexi√≥n perdida. Recarga la p√°gina.", true);
    };

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === "message") {
        addMessage(data.text, "agent");
        speakWithInterrupt(data.text);
      }
    };

    // ============================================================================
    // RECONOCIMIENTO DE VOZ CON FILTROS DE AUDIO OPTIMIZADOS
    // ============================================================================

    /**
     * Inicializa el stream de audio con filtros avanzados para mejorar la calidad.
     *
     * Filtros aplicados:
     * - echoCancellation: Elimina eco del altavoz
     * - noiseSuppression: Reduce ruido ambiental
     * - autoGainControl: Normaliza el volumen autom√°ticamente
     */
    async function initializeAudioStream() {
      try {
        // Solicitar acceso al micr√≥fono con filtros de calidad
        audioStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,      // Cancelaci√≥n de eco
            noiseSuppression: true,       // Supresi√≥n de ruido
            autoGainControl: true,        // Control autom√°tico de ganancia
            sampleRate: 48000,            // Alta calidad de audio
            channelCount: 1               // Mono (suficiente para voz)
          }
        });
        console.log("‚úÖ Stream de audio inicializado con filtros de calidad");
        return true;
      } catch (error) {
        console.error("‚ùå Error al inicializar stream de audio:", error);
        showError("No se pudo acceder al micr√≥fono. Verifica los permisos.", true);
        return false;
      }
    }

    /**
     * Configura el reconocimiento de voz con detecci√≥n optimizada (VAD).
     *
     * Caracter√≠sticas:
     * - Reconocimiento continuo para flujo natural
     * - Reinicio autom√°tico tras finalizaci√≥n
     * - Detecci√≥n de silencio optimizada
     * - Interrupci√≥n autom√°tica cuando el agente habla
     */
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();

      // Configuraci√≥n b√°sica
      recognition.lang = "es-ES";
      recognition.continuous = true;        // Escucha continua sin detener
      recognition.interimResults = false;   // Solo resultados finales (m√°s precisi√≥n)
      recognition.maxAlternatives = 1;      // Una sola alternativa (m√°s r√°pido)

      recognition.onstart = () => {
        isListening = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        status.textContent = "Escuchando...";
        status.classList.add("listening");
        console.log("üé§ Reconocimiento de voz iniciado");
      };

      recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript;
        const confidence = event.results[event.results.length - 1][0].confidence;

        console.log(`üìù Transcripci√≥n: "${transcript}" (confianza: ${(confidence * 100).toFixed(1)}%)`);

        addMessage(transcript, "user");

        // BARGE-IN: Si el agente est√° hablando, interrumpirlo inmediatamente
        if (isAgentSpeaking) {
          console.log("‚ö° Interrupci√≥n detectada - parando al agente");
          interruptAgentSpeech();
        }

        // Enviar mensaje al servidor
        socket.send(JSON.stringify({ type: "user_message", text: transcript }));
      };

      recognition.onerror = (event) => {
        console.error("‚ùå Error de reconocimiento:", event.error);

        // Manejo espec√≠fico de errores
        switch(event.error) {
          case "not-allowed":
            showError("Permisos de micr√≥fono denegados. Permite el acceso al micr√≥fono.", true);
            isListening = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            break;
          case "no-speech":
            console.log("‚è∏Ô∏è No se detect√≥ voz, continuando escucha...");
            break;
          case "audio-capture":
            showError("Error al capturar audio. Verifica tu micr√≥fono.", true);
            break;
          case "network":
            showError("Error de red. Verifica tu conexi√≥n a internet.", true);
            break;
          default:
            console.warn(`‚ö†Ô∏è Error de reconocimiento: ${event.error}`);
        }
      };

      /**
       * Reinicio autom√°tico del reconocimiento para conversaci√≥n continua.
       *
       * Estrategia:
       * - Espera 100ms antes de reiniciar (evita conflictos)
       * - Solo reinicia si seguimos en modo escucha
       * - Maneja errores de reinicio gracefully
       */
      recognition.onend = () => {
        console.log("üîÑ Reconocimiento finalizado");

        if (isListening) {
          // Reinicio autom√°tico con peque√±o delay para estabilidad
          setTimeout(() => {
            if (isListening) {
              try {
                recognition.start();
                console.log("‚ôªÔ∏è Reconocimiento reiniciado autom√°ticamente");
              } catch (error) {
                console.error("‚ùå Error al reiniciar reconocimiento:", error);
                // Si falla el reinicio, marcar como no escuchando
                isListening = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                status.textContent = "Conectado";
                status.classList.remove("listening");
              }
            }
          }, 100); // 100ms de delay para evitar conflictos
        } else {
          status.textContent = "Conectado";
          status.classList.remove("listening");
        }
      };
    } else {
      showError("Tu navegador no soporta reconocimiento de voz. Usa Chrome o Edge.", true);
      startBtn.disabled = true;
    }

    // ============================================================================
    // S√çNTESIS DE VOZ CON TONO C√ÅLIDO Y PROFESIONAL
    // ============================================================================

    /**
     * Limpia el texto de caracteres markdown y formato para s√≠ntesis de voz natural.
     *
     * Elimina:
     * - Asteriscos de negrita/cursiva (**texto**, *texto*)
     * - N√∫meros y guiones de listas (1. , 2. , - )
     * - Encabezados markdown (# , ## , ###)
     * - Otros caracteres de formato que interrumpen la fluidez
     *
     * @param {string} text - Texto con formato markdown
     * @returns {string} - Texto limpio para s√≠ntesis de voz
     */
    function cleanTextForSpeech(text) {
      let cleaned = text;

      // Eliminar asteriscos de negrita y cursiva (**, *, ***)
      cleaned = cleaned.replace(/\*\*\*/g, '');  // *** (negrita+cursiva)
      cleaned = cleaned.replace(/\*\*/g, '');    // ** (negrita)
      cleaned = cleaned.replace(/\*/g, '');      // * (cursiva)

      // Eliminar guiones bajos de cursiva (_, __)
      cleaned = cleaned.replace(/__/g, '');      // __ (negrita)
      cleaned = cleaned.replace(/_/g, '');       // _ (cursiva)

      // Eliminar encabezados markdown (# , ## , ###, etc.)
      cleaned = cleaned.replace(/^#{1,6}\s+/gm, '');

      // Eliminar n√∫meros de lista al inicio de l√≠nea (1. , 2. , etc.)
      cleaned = cleaned.replace(/^\d+\.\s+/gm, '');

      // Eliminar guiones de lista al inicio de l√≠nea (- , * al inicio)
      cleaned = cleaned.replace(/^[-*]\s+/gm, '');

      // Eliminar saltos de l√≠nea m√∫ltiples y reemplazar por pausas naturales
      cleaned = cleaned.replace(/\n{2,}/g, '. ');  // Dobles saltos ‚Üí pausa
      cleaned = cleaned.replace(/\n/g, ', ');       // Saltos simples ‚Üí coma

      // Eliminar espacios m√∫ltiples
      cleaned = cleaned.replace(/\s{2,}/g, ' ');

      // Trim espacios al inicio y final
      cleaned = cleaned.trim();

      console.log("üßπ Texto limpiado para voz:", cleaned.substring(0, 80) + "...");
      return cleaned;
    }

    /**
     * Sintetiza el texto del agente con voz natural y permite interrupciones.
     *
     * Caracter√≠sticas de la voz:
     * - Voz espa√±ola femenina de alta calidad (Google/Microsoft preferida)
     * - Rate 0.9: Velocidad ligeramente m√°s lenta para claridad
     * - Pitch 1.05: Tono ligeramente elevado para calidez
     * - Volume 1.0: Volumen completo para audibilidad
     * - Limpieza autom√°tica de markdown para voz natural
     *
     * @param {string} text - Texto a sintetizar (puede contener markdown)
     */
    function speakWithInterrupt(text) {
      if ('speechSynthesis' in window) {
        // Parar cualquier s√≠ntesis anterior
        speechSynthesis.cancel();

        // Limpiar texto de markdown antes de sintetizar
        const cleanedText = cleanTextForSpeech(text);

        const utterance = new SpeechSynthesisUtterance(cleanedText);

        // Configuraci√≥n de idioma y voz
        utterance.lang = "es-ES";
        utterance.voice = selectedVoice; // Voz espa√±ola de calidad seleccionada

        // Ajustes para tono c√°lido y profesional
        utterance.rate = 0.9;    // Velocidad: ligeramente m√°s lenta para claridad
        utterance.pitch = 1.05;  // Tono: ligeramente elevado para calidez
        utterance.volume = 1.0;  // Volumen: completo para buena audibilidad

        // Marcar que el agente est√° hablando
        isAgentSpeaking = true;

        utterance.onstart = () => {
          console.log("üó£Ô∏è Agente empez√≥ a hablar (limpio):", cleanedText.substring(0, 50) + "...");
          speakingIndicator.style.display = "block";
        };

        utterance.onend = () => {
          isAgentSpeaking = false;
          speakingIndicator.style.display = "none";
          console.log("‚úÖ Agente termin√≥ de hablar");
        };

        utterance.onerror = (event) => {
          isAgentSpeaking = false;
          speakingIndicator.style.display = "none";
          console.error("‚ùå Error en s√≠ntesis de voz:", event.error);
        };

        // Iniciar s√≠ntesis
        speechSynthesis.speak(utterance);
        console.log(`üéôÔ∏è Sintetizando con voz: ${selectedVoice ? selectedVoice.name : 'predeterminada'}`);
      }
    }

    /**
     * BARGE-IN: Interrupci√≥n robusta del agente cuando el usuario empieza a hablar.
     *
     * Comportamiento:
     * - Cancela inmediatamente la s√≠ntesis de voz
     * - Resetea el estado isAgentSpeaking
     * - Oculta el indicador visual
     * - Muestra mensaje de interrupci√≥n en el chat
     */
    function interruptAgentSpeech() {
      if ('speechSynthesis' in window && isAgentSpeaking) {
        console.log("‚ö° Interrumpiendo al agente...");

        // Cancelar s√≠ntesis inmediatamente
        speechSynthesis.cancel();

        // Resetear estado
        isAgentSpeaking = false;
        speakingIndicator.style.display = "none";

        // Mostrar mensaje de interrupci√≥n en el chat
        addMessage("(interrumpido)", "agent");

        console.log("‚úÖ Agente interrumpido exitosamente");
      }
    }

    // ============================================================================
    // EVENTOS DE BOTONES
    // ============================================================================

    startBtn.onclick = async () => {
      if (recognition) {
        // Inicializar stream de audio con filtros (primera vez)
        if (!audioStream) {
          const success = await initializeAudioStream();
          if (!success) return; // Abortar si fall√≥
        }

        // Mostrar conversaci√≥n e iniciar reconocimiento
        conversation.style.display = "block";

        try {
          recognition.start();
        } catch (error) {
          console.error("‚ùå Error al iniciar reconocimiento:", error);
          showError("Error al iniciar el reconocimiento de voz.", true);
        }
      }
    };

    stopBtn.onclick = () => {
      if (recognition) {
        isListening = false;
        recognition.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
        status.textContent = "Conectado";
        status.classList.remove("listening");
        console.log("‚èπÔ∏è Reconocimiento detenido manualmente");
      }
    };

    clearBtn.onclick = () => {
      conversation.innerHTML = "";
      console.log("üóëÔ∏è Chat limpiado");
    };

    // ============================================================================
    // FUNCIONES AUXILIARES
    // ============================================================================

    /**
     * A√±ade un mensaje al chat con scroll autom√°tico.
     *
     * @param {string} text - Texto del mensaje
     * @param {string} sender - "user" o "agent"
     */
    function addMessage(text, sender) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender}`;
      messageDiv.textContent = text;
      conversation.appendChild(messageDiv);

      // Scroll autom√°tico al √∫ltimo mensaje
      conversation.scrollTop = conversation.scrollHeight;
    }

    /**
     * Muestra u oculta mensajes de error.
     *
     * @param {string} message - Mensaje de error
     * @param {boolean} show - Si mostrar o no el error
     */
    function showError(message, show) {
      if (show) {
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      } else {
        errorDiv.style.display = "none";
      }
    }

    // ============================================================================
    // LIMPIEZA AL CERRAR LA P√ÅGINA
    // ============================================================================

    window.addEventListener('beforeunload', () => {
      // Detener reconocimiento
      if (recognition && isListening) {
        isListening = false;
        recognition.stop();
      }

      // Detener s√≠ntesis
      if (isAgentSpeaking) {
        speechSynthesis.cancel();
      }

      // Cerrar stream de audio
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
      }

      console.log("üîö Limpieza completada");
    });
  </script>
</body>
</html>
